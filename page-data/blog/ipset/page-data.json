{"componentChunkName":"component---src-templates-markdown-post-js","path":"/blog/ipset","result":{"data":{"markdownRemark":{"html":"<p>서비스를 운영하다보면, 종종 특정 국가에서만 접속을 허용하거나, 특정 국가에서 접속하지 못하도록 화이트리스트/블랙리스트를 구성해야 하는 경우가 있습니다.\n이러한 <code class=\"language-text\">ipset</code>을 이용하여 이런 목록들을 구성하고, <code class=\"language-text\">iptables</code>을 이용하여 해당 목록으로 접속을 차단하거나 허용하도록 규칙을 추가해보았습니다.</p>\n<h2>ipset 설치</h2>\n<p>먼저 리스트를 구성하기 위해 패키지 관리자를 통해 ipset을 설치합니다.</p>\n<h3>CentOS</h3>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">yum install ipset -y</span></span></code></pre>\n<h3>Ubuntu</h3>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">apt-get install ipset -y</span></span></code></pre>\n<h2>IP 목록 다운로드</h2>\n<p>필요한 IP CIDR 목록 파일을 다운로드 받습니다.\n아래는 한국 IP에서만 접속을 허용하기 위해 작성된 목록입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">curl https://ludorum.keybase.pub/ipset/kr.zone -o kr.zone</span></span></code></pre>\n<ul>\n<li><a href=\"https://www.ipdeny.com/ipblocks/\">IPDeny</a></li>\n<li><a href=\"https://ludorum.keybase.pub/ipset/kr.zone\">한국 IP목록</a></li>\n</ul>\n<h2>ipset 설정</h2>\n<p>ipset을 생성하고 ip대역을 추가합니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">ipset -N kr hash:net</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk15\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">$(cat kr.zone)</span><span class=\"mtk1\">; </span><span class=\"mtk15\">do</span><span class=\"mtk1\"> ipset -A kr </span><span class=\"mtk12\">$a</span><span class=\"mtk1\">; </span><span class=\"mtk15\">done</span></span></code></pre>\n<p>추가된 목록을 확인합니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">ipset list | less</span></span></code></pre>\n<h2>iptables 설정하기</h2>\n<p>아래 예시를 참고하여 iptable을 설정합니다.</p>\n<h3>예시) 허용된 KR IP외에 모든 IP에서 80, 443포트 차단하기</h3>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">iptables -A INPUT -p tcp -m </span><span class=\"mtk11\">set</span><span class=\"mtk1\"> --match-set kr src --dport 80 -j ACCEPT</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">iptables -A INPUT -p tcp -m </span><span class=\"mtk11\">set</span><span class=\"mtk1\"> --match-set kr src --dport 443 -j ACCEPT</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">iptables -A INPUT -p tcp --dport 443 -j DROP</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">iptables -A INPUT -p tcp --dport 80 -j DROP</span></span></code></pre>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n  }\n  \n  .grvsc-code {\n    display: inline-block;\n    min-width: 100%;\n  }\n  \n  .grvsc-line {\n    display: inline-block;\n    box-sizing: border-box;\n    width: 100%;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-line-highlighted {\n    background-color: var(--grvsc-line-highlighted-background-color, transparent);\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, transparent);\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n</style>","frontmatter":{"date":"May 22, 2020","slug":"/blog/ipset","title":"ipset을 사용하여 iptables에 국가 필터링하기"}}},"pageContext":{"slug":"/blog/ipset"}}}